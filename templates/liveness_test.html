<!-- templates/liveness_test.html -->
{% extends "base.html" %}

{% block title %}”®–º—ñ—Ä—à–µ“£–¥—ñ–∫—Ç—ñ —Ç–µ–∫—Å–µ—Ä—É - Face Recognition System{% endblock %}

{% block content %}
<div class="video-container">
    <h1>üé• –ë–µ—Ç—Ç—ñ —Ç—ñ—Ä–∫–µ—É</h1>
    <p style="text-align: center; margin-bottom: 20px;">
        “ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑, <strong>{{ username }}</strong>!
    </p>
    
    <div class="instructions">
        <h3>–°”ô—Ç—Ç—ñ —Ç—ñ—Ä–∫–µ—É–≥–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω –Ω“±—Å“õ–∞—É–ª–∞—Ä:</h3>
        <ul>
            <li>–ö”©–∑—ñ–ª–¥—ñ—Ä—ñ–∫—Ç—ñ, –º–∞—Å–∫–∞–Ω—ã –∂”ô–Ω–µ –±–∞—Å –∫–∏—ñ–º–¥—ñ —à–µ—à—ñ“£—ñ–∑</li>
            <li>–ë–µ—Ç—ñ“£—ñ–∑–¥—ñ –∫–∞–¥—Ä–¥—ã“£ –æ—Ä—Ç–∞—Å—ã–Ω–¥–∞ “±—Å—Ç–∞“£—ã–∑</li>
            <li>–ñ–∞“õ—Å—ã –∂–∞—Ä—ã“õ—Ç–∞–Ω–¥—ã—Ä—É–¥—ã “õ–∞–º—Ç–∞–º–∞—Å—ã–∑ –µ—Ç—ñ“£—ñ–∑</li>
            <li>–¢–∞–±–∏“ì–∏ –∂—ã–ø—ã–ª—ã“õ—Ç–∞—É</li>
            <li>–ë–∞—Å—ã“£ƒ±z–¥—ã —Å”ô–ª –±“±—Ä—ã“£—ã–∑</li>
        </ul>
    </div>
    
    <img id="video" src="{{ url_for('video_feed') }}" alt="Video Stream">
    
    <div class="status-panel">
        <h3 style="margin-bottom: 15px;">–¢–µ–∫—Å–µ—Ä—É –∫“Ø–π—ñ:</h3>
        <div class="status-item">
            <span class="status-label">–ë–µ—Ç —Ç–∞–±—ã–ª–¥—ã:</span>
            <span class="status-value" id="face-status">–¢–µ–∫—Å–µ—Ä—É...</span>
        </div>
        <div class="status-item">
            <span class="status-label">”®–º—ñ—Ä—à–µ“£–¥—ñ–∫:</span>
            <span class="status-value" id="liveness-status">–¢–µ–∫—Å–µ—Ä—É...</span>
        </div>
        <div class="status-item">
            <span class="status-label">–ê–∫—Å–µ—Å—Å—É–∞—Ä:</span>
            <span class="status-value" id="accessory-status">–¢–µ–∫—Å–µ—Ä—É...</span>
        </div>
        <div class="status-item">
            <span class="status-label">–ñ–∞–ª–ø—ã –∫“Ø–π—ñ:</span>
            <span class="status-value" id="overall-status">–ö“Ø—Ç—É...</span>
        </div>
    </div>
    
    <button class="btn btn-secondary" onclick="window.location.href='/logout'">
        –ë–æ–ª–¥—ã—Ä–º–∞—É
    </button>
</div>

<script>
    let testCompleted = false;

    function updateStatus() {
        if (testCompleted) {
            console.log("–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.");
            return;
        }

        fetch('/get_detection_status')
            .then(response => {
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ HTTP: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log("–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ª–∏—Ü–∞
                const faceStatus = document.getElementById('face-status');
                if (data.face_detected) {
                    faceStatus.textContent = '–î–∞';
                    faceStatus.className = 'status-value success';
                } else {
                    faceStatus.textContent = '–ù–µ—Ç';
                    faceStatus.className = 'status-value error';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∂–∏–≤—É—á–µ—Å—Ç–∏
                const livenessStatus = document.getElementById('liveness-status');
                livenessStatus.textContent = data.liveness_status;
                if (data.is_real) {
                    livenessStatus.className = 'status-value success';
                } else {
                    livenessStatus.className = 'status-value error';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤
                const accessoryStatus = document.getElementById('accessory-status');
                accessoryStatus.textContent = data.accessory_status;
                if (data.no_accessories) {
                    accessoryStatus.className = 'status-value success';
                } else {
                    accessoryStatus.className = 'status-value error';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
                const overallStatus = document.getElementById('overall-status');
                if (data.face_detected && data.is_real && data.no_accessories) {
                    overallStatus.textContent = '–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!';
                    overallStatus.className = 'status-value success';
                } else {
                    overallStatus.textContent = '–¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω';
                    overallStatus.className = 'status-value error';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ª–∏ —Ç–µ—Å—Ç
                if (data.test_completed) {
                    console.log("–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω, test_completed:", data.test_completed, "test_passed:", data.test_passed);
                    if (data.test_passed) {
                        testCompleted = true;
                        overallStatus.textContent = '–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...';
                        console.log("–¢–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω, –æ–∂–∏–¥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...");
                    }
                }

                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                if (data.auto_redirect) {
                    testCompleted = true;
                    console.log("–ü–æ–ª—É—á–µ–Ω–æ auto_redirect, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞:", data.redirect_url);
                    window.location.href = data.redirect_url;
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                testCompleted = true;
                document.getElementById('overall-status').textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...';
                document.getElementById('overall-status').className = 'status-value error';
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1000);
            });
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 500–º—Å
    const statusInterval = setInterval(updateStatus, 500);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updateStatus();

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 7 —Å–µ–∫—É–Ω–¥, –µ—Å–ª–∏ —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω, –Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ
    setTimeout(() => {
        if (!testCompleted && window.location.pathname === '/liveness_test') {
            console.log("–¢–µ—Å—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –≤–æ–≤—Ä–µ–º—è, –≤—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.");
            alert('–¢–µ—Å—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –≤–æ–≤—Ä–µ–º—è. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ä—É—á–Ω—É—é.');
            window.location.href = '/dashboard';
        } else if (testCompleted && window.location.pathname === '/liveness_test') {
            console.log("–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω, –Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ, –≤—ã–ø–æ–ª–Ω—è–µ–º –≤—Ä—É—á–Ω—É—é.");
            alert('–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ä—É—á–Ω—É—é.');
            window.location.href = '/dashboard';
        }
    }, 90000); // 88 —Å–µ–∫—É–Ω–¥ —Ç–µ—Å—Ç–∞ + 2 —Å–µ–∫—É–Ω–¥—ã –æ–∂–∏–¥–∞–Ω–∏—è
</script>
{% endblock %}